Cumberland <- VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000026" | VehFleet$`Local Authority Code` ==
"E07000028" | VehFleet$`Local Authority Code` ==
"E07000029"),]
Cumberland2 <- c("E06000063", colSums(Cumberland[,2:6]))
VehFleet <- rbind(VehFleet, Cumberland2)
WestmorlandFurness <- VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000027" | VehFleet$`Local Authority Code` ==
"E07000030" | VehFleet$`Local Authority Code` ==
"E07000031"),]
WestmorlandFurness <- WestmorlandFurness %>% mutate_at(c(2:6), as.numeric)
WestmorlandFurness2 <- c("E06000064", colSums(WestmorlandFurness[,2:6]))
VehFleet <- rbind(VehFleet, WestmorlandFurness2)
VehFleet <- VehFleet %>% mutate_at(c(2:6), as.numeric)
#Calculate total cars and percentages to determine 'average car' per upper tier LA
VehFleet$TotalCars <- rowSums(VehFleet[2:6], na.rm = T)
VehFleet$Petrol <- VehFleet$Petrol2024Q2/VehFleet$TotalCars
VehFleet$Diesel <- VehFleet$Diesel2024Q2/VehFleet$TotalCars
VehFleet$Hybrid <- VehFleet$Hybrid2024Q2/VehFleet$TotalCars
VehFleet$BEV <- VehFleet$BEV2024Q2/VehFleet$TotalCars
VehFleet$PHEV <- VehFleet$PHEV2024Q2/VehFleet$TotalCars
TrafficFleet <- left_join(VehFleet, Traffic) #423 upper and lower tier authorities
#Clean dataframe and prepare for joining to geojson
#4 upper tier LAs have different codes in VehFleet files that are in Mileage files
#Somerset and North Yorkshire (changed lower tier code to upper tier code)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000027",
"E06000066", TrafficFleet$`Local Authority Code`)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000023",
"E06000065", TrafficFleet$`Local Authority Code`)
#Three authorities have different names on the geojson
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Herefordshire",
"Herefordshire, County of", TrafficFleet$`Local Authority`)
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Bristol",
"Bristol, City of", TrafficFleet$`Local Authority`)
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Kingston upon Hull",
"Kingston upon Hull, City of", TrafficFleet$`Local Authority`)
#remove 215 NAs - 208 upper tier LAs
TrafficFleet <- TrafficFleet[!is.na(TrafficFleet$cars_and_taxis),]
#calculate mileage and emissions by car type per upper tier LA
TrafficFleet$PetrolMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Petrol
TrafficFleet$DieselMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Diesel
TrafficFleet$HybridMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Hybrid
TrafficFleet$BEVMile <- TrafficFleet$cars_and_taxis*TrafficFleet$BEV
TrafficFleet$PHEVMile <- TrafficFleet$cars_and_taxis*TrafficFleet$PHEV
TrafficFleet$PetrolCO2e <- TrafficFleet$PetrolMile*0.26473
TrafficFleet$DieselCO2e <- TrafficFleet$DieselMile*0.27334
TrafficFleet$HybridCO2e <- TrafficFleet$HybridMile*0.20288
TrafficFleet$BEVCO2e <- TrafficFleet$BEVMile*0.07015+(TrafficFleet$BEVMile*0.00620)
TrafficFleet$PHEVCO2e <- TrafficFleet$PHEVMile*(0.14989+0.02208+0.00195)
#sum baseline CO2e and baseline CO2e and mileage for per vehicle in LA fleet
TrafficFleet$BaseCO2e <- rowSums(TrafficFleet[,23:27], na.rm = TRUE)
TrafficFleet$pCarBaseCO2e <- TrafficFleet$BaseCO2e/TrafficFleet$TotalCars
TrafficFleet$pCarAnnMile <- TrafficFleet$cars_and_taxis/TrafficFleet$TotalCars
#use mileage in fleet to create conversion factors for CO2 emissions reductions per CC car
TrafficFleet$pBEVAnnCO2e <- TrafficFleet$pCarAnnMile*0.07015+(TrafficFleet$pCarAnnMile*0.00620)
TrafficFleet$pHyVAnnCO2e <- TrafficFleet$pCarAnnMile*0.20288
TrafficFleet$reduceCO2pBEVcc <- TrafficFleet$pCarBaseCO2e - TrafficFleet$pBEVAnnCO2e
TrafficFleet$reduceCO2pHyVc <- TrafficFleet$pCarBaseCO2e - TrafficFleet$pHyVAnnCO2e
#output to use in mapping
write.csv(TrafficFleet, "../data/processed_data/LAoutputFleet.csv")
library(dplyr)
library(data.table)
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- fread("../data/raw_data/LookupLtoMSOA21.csv")
Lookup21 <- LookupPC[,c(8:9)]
names(Lookup21)[1] <- "LSOA21CD"
names(Lookup21)[2] <- "MSOA21CD"
Lookup21 <- distinct(Lookup21) #43501obs
Lookup2011 <- read.csv("../data/raw_data/LSOA_(2011)_to_LSOA_(2021)_to_Local_Authority_District_(2022)_Lookup_for_England_and_Wales.csv")
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- fread("../data/raw_data/LookupLtoMSOA21.csv")
Lookup21 <- Lookup21[,c(8:9)]
names(Lookup21)[1] <- "LSOA21CD"
names(Lookup21)[2] <- "MSOA21CD"
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- fread("../data/raw_data/LookupLtoMSOA21.csv")
summary(Lookup21)
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- read.csv("../data/raw_data/LookupLtoMSOA21.csv")
summary(Lookup21)
Lookup2011 <- read.csv("../data/raw_data/LSOA_(2011)_to_LSOA_(2021)_to_Local_Authority_District_(2022)_Lookup_for_England_and_Wales.csv")
Lookup2011 <- Lookup2011[,c(1,3,5:6)]
names (Lookup2011)[1] <- "LSOA11CD"
Lookup <- left_join(Lookup21, Lookup2011) #43621obs
#Total Hholds and type by LSOA
HHoldVars <- read.csv("../data/raw_data/HHoldAccommodationType.csv")
HHoldVars$X2021.super.output.area...lower.layer <-
substr(HHoldVars$X2021.super.output.area...lower.layer,1,9)
names(HHoldVars)[1] <- "LSOA21CD"
HHoldVars <- HHoldVars[,1:2]
HHoldVars$Total.hholds <- as.numeric(HHoldVars$Total.hholds)
MSOAoutput <- left_join(Lookup, HHoldVars)
#Add Car registration rates by LSOA
AllVehReg <- fread("..../data/raw_data/df_VEH0125_col13456.csv")
#Add Car registration rates by LSOA
AllVehReg <- fread("..../data/raw_data/df_VEH0125_col13456.csv")
#Add Car registration rates by LSOA
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "LSOAVehsReg2024Q2"
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
MSOAoutput <- MSOAoutput[!is.na(MSOAoutput$LSOAVehsReg2024Q2),]
str(AllVehReg)
AllVehReg$LSOA11CD <- as.character(AllVehReg$LSOA11CD)
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
MSOAoutput <- left_join(Lookup, HHoldVars)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
summary(AllVehReg)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
AllVehReg$LSOA11CD <- as.character(AllVehReg$LSOA11CD)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "LSOAVehsReg2024Q2"
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
str(AllVehReg)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
str(AllVehReg)
rm(AllVehReg)
MSOAoutput <- MSOAoutput[!is.na(MSOAoutput$LSOAVehsReg2024Q2),]
#round 53 LSOA outliers to account for where there are car rental businesses, fleets registered, etc
#double max hholds per LSOA is 3954, so maximum capped at 4k registered cars per LSOA
MSOAoutput$LSOAVehsReg2024Q2 <- if_else(MSOAoutput$LSOAVehsReg2024Q2 > 4000,
4000, MSOAoutput$LSOAVehsReg2024Q2)
#Rates of cars registered by total households
MSOAoutput$CarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$Total.hholds
#Rates of cars registered by total households
MSOAoutput$LSOACarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$Total.hholds
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("..../data/raw_data/df_VEH0145_col1345.csv")
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("../data/raw_data/df_VEH0145_col1345.csv")
names(EVReg)[1] <- "LSOA11CD"
EVReg$Fuel <- as.factor(EVReg$Fuel)
EVReg$Keepership <- as.factor(EVReg$Keepership)
#include only fully electric but company or private ownership
EVReg <- EVReg[which(EVReg$Fuel == "Battery electric"),]
EVReg <- EVReg[which(EVReg$Keepership == "Total"),]
EVReg <- EVReg[,c(1,4)]
EVReg$`2024 Q2` <- as.numeric(EVReg$`2024 Q2`)
names(EVReg)[2] <- "LSOAEV2024Q2"
EVReg$LSOAEV2024Q2 <- if_else(is.na(EVReg$LSOAEV2024Q2),0,EVReg$LSOAEV2024Q2)
MSOAoutput <- left_join(MSOAoutput,EVReg)
#round 17 outliers as did with total vehs - double max hholds per LSOA is 3954, so rounded to 4k
MSOAoutput$LSOAEV2024Q2 <- if_else(MSOAoutput$LSOAEV2024Q2 > 4000,
4000, MSOAoutput$LSOAEV2024Q2)
MSOAoutput$LSOAEVRate <- (MSOAoutput$LSOAEV2024Q2/MSOAoutput$LSOAVehsReg2024Q2)
#LSOA reduction in car ownership rates
MSOAoutput$LSOACCCarOwn <- (MSOAoutput$LSOAVehsReg2024Q2 - 9)/MSOAoutput$Total.hholds
MSOAoutput$LSOACCredCarOwn <- (MSOAoutput$LSOACCCarOwn - MSOAoutput$LSOACarOwnRates)
#LSOA changes in EV uptake
MSOAoutput$LSOAEVincCC <- (MSOAoutput$LSOAEV2024Q2 + 9)
MSOAoutput$LSOAEVRateincCC <- (MSOAoutput$LSOAEVincCC/(MSOAoutput$LSOAVehsReg2024Q2-8))
MSOAoutput$LSOAChangeEVuptake <- (MSOAoutput$LSOAEVRateincCC - MSOAoutput$LSOAEVRate)*100
#aggregate populations, total households, car ownership and EV uptake by MSOA
TotHholdMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(Total.hholds, na.rm = T))
names(TotHholdMSOA)[2] <- "TotHholdMSOA"
MSOAoutput <- left_join(MSOAoutput, TotHholdMSOA)
#Total Hholds by LSOA
#data from census: https://www.nomisweb.co.uk/query/select/getdatasetbytheme.asp
#select census 2021, Table 041 number of households, geography: all 2021 super output areas - lower layer
HHolds <- read.csv("../data/raw_data/HHoldNumbers.csv")
summary(HHolds)
HHoldVars$X2021.super.output.area...lower.layer <-
substr(HHoldVars$X2021.super.output.area...lower.layer,1,9)
HHolds$X2021.super.output.area...lower.layer <-
substr(HHolds$X2021.super.output.area...lower.layer,1,9)
names(HHolds)[1] <- "LSOA21CD"
names(HHolds) <- c("LSOA21CD","LSOAtotHholds")
HHolds$LSOAtotHholds <- as.numeric(HHolds$LSOAtotHholds)
MSOAoutput <- left_join(Lookup, HHolds)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "LSOAVehsReg2024Q2"
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
MSOAoutput <- MSOAoutput[!is.na(MSOAoutput$LSOAVehsReg2024Q2),] #remove Scotland - 34753 obs
#round 53 LSOA outliers to account for where there are car rental businesses, fleets registered, etc
#double max hholds per LSOA is 3954, so maximum capped at 4k registered cars per LSOA
MSOAoutput$LSOAVehsReg2024Q2 <- if_else(MSOAoutput$LSOAVehsReg2024Q2 > 4000,
4000, MSOAoutput$LSOAVehsReg2024Q2)
#Rates of cars registered by total households
MSOAoutput$LSOACarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$Total.hholds
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("../data/raw_data/df_VEH0145_col1345.csv")
#Rates of cars registered by total households
MSOAoutput$LSOACarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$LSOAtotHholds
names(EVReg)[1] <- "LSOA11CD"
EVReg$Fuel <- as.factor(EVReg$Fuel)
EVReg$Keepership <- as.factor(EVReg$Keepership)
#include only fully electric but company or private ownership
EVReg <- EVReg[which(EVReg$Fuel == "Battery electric"),]
EVReg <- EVReg[which(EVReg$Keepership == "Total"),]
EVReg <- EVReg[,c(1,4)]
EVReg$`2024 Q2` <- as.numeric(EVReg$`2024 Q2`)
names(EVReg)[2] <- "LSOAEV2024Q2"
EVReg$LSOAEV2024Q2 <- if_else(is.na(EVReg$LSOAEV2024Q2),0,EVReg$LSOAEV2024Q2)
MSOAoutput <- left_join(MSOAoutput,EVReg)
#round 17 outliers as did with total vehs - double max hholds per LSOA is 3954, so rounded to 4k
MSOAoutput$LSOAEV2024Q2 <- if_else(MSOAoutput$LSOAEV2024Q2 > 4000,
4000, MSOAoutput$LSOAEV2024Q2)
MSOAoutput$LSOAEVRate <- (MSOAoutput$LSOAEV2024Q2/MSOAoutput$LSOAVehsReg2024Q2)
#LSOA reduction in car ownership rates
MSOAoutput$LSOACCCarOwn <- (MSOAoutput$LSOAVehsReg2024Q2 - 9)/MSOAoutput$Total.hholds
MSOAoutput$LSOACCredCarOwn <- (MSOAoutput$LSOACCCarOwn - MSOAoutput$LSOACarOwnRates)
#LSOA changes in EV uptake
MSOAoutput$LSOAEVincCC <- (MSOAoutput$LSOAEV2024Q2 + 9)
#LSOA reduction in car ownership rates
MSOAoutput$LSOACCCarOwn <- (MSOAoutput$LSOAVehsReg2024Q2 - 9)/MSOAoutput$LSOAtotHholds
MSOAoutput$LSOACCredCarOwn <- (MSOAoutput$LSOACCCarOwn - MSOAoutput$LSOACarOwnRates)
#LSOA changes in EV uptake
MSOAoutput$LSOAEVincCC <- (MSOAoutput$LSOAEV2024Q2 + 9)
MSOAoutput$LSOAEVRateincCC <- (MSOAoutput$LSOAEVincCC/(MSOAoutput$LSOAVehsReg2024Q2-8))
MSOAoutput$LSOAChangeEVuptake <- (MSOAoutput$LSOAEVRateincCC - MSOAoutput$LSOAEVRate)*100
#aggregate populations, total households, car ownership and EV uptake by MSOA
TotHholdMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(Total.hholds, na.rm = T))
#aggregate populations, total households, car ownership and EV uptake by MSOA
TotHholdMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(LSOAtotHholds, na.rm = T))
names(TotHholdMSOA)[2] <- "TotHhold"
MSOAoutput <- left_join(MSOAoutput, TotHholdMSOA)
VehsRegMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(LSOAVehsReg2024Q2, na.rm = T))
names(VehsRegMSOA)[2]<- "VehsReg"
MSOAoutput <- left_join(MSOAoutput, VehsRegMSOA)
MSOAoutput$CarOwnRates <- MSOAoutput$VehsReg / MSOAoutput$TotHhold
EVRegMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(LSOAEV2024Q2, na.rm = T))
names(EVRegMSOA)[2]<-"EVReg"
MSOAoutput <- left_join(MSOAoutput, EVRegMSOA)
MSOAoutput$EVRate <- (MSOAoutput$EVReg/MSOAoutput$VehsReg)
#MSOA reduction in car ownership
MSOAoutput$CarRedincCC <- (MSOAoutput$VehsReg - 9)
?weighted.mean
library(dplyr)
library(data.table)
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- read.csv("../data/raw_data/LookupLtoMSOA21.csv") #43501obs
Lookup2011 <- read.csv("../data/raw_data/LSOA_(2011)_to_LSOA_(2021)_to_Local_Authority_District_(2022)_Lookup_for_England_and_Wales.csv")
Lookup2011 <- Lookup2011[,c(1,3,5:6)]
names (Lookup2011)[1] <- "LSOA11CD"
Lookup <- left_join(Lookup21, Lookup2011) #43621obs
#Total Hholds by LSOA
#data from census: https://www.nomisweb.co.uk/query/select/getdatasetbytheme.asp
#select census 2021, Table 041 number of households, geography: all 2021 super output areas - lower layer
HHolds <- read.csv("../data/raw_data/HHoldNumbers.csv")
HHolds$X2021.super.output.area...lower.layer <-
substr(HHolds$X2021.super.output.area...lower.layer,1,9)
names(HHolds) <- c("LSOA21CD","TotHhold")
HHolds$TotHhold <- as.numeric(HHolds$TotHhold)
LSOAoutput <- left_join(Lookup, HHolds)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "VehsReg2024Q2"
LSOAoutput <- left_join(LSOAoutput, AllVehReg)
LSOAoutput <- LSOAoutput[!is.na(LSOAoutput$VehsReg2024Q2),] #remove Scotland - 34753 obs
#round 53 LSOA outliers to account for where there are car rental businesses, fleets registered, etc
#double max hholds per LSOA is 3954, so maximum capped at 4k registered cars per LSOA
LSOAoutput$VehsReg2024Q2 <- if_else(LSOAoutput$VehsReg2024Q2 > 4000,
4000, LSOAoutput$VehsReg2024Q2)
#Rates of cars registered by total households
LSOAoutput$CarOwnRates <- LSOAoutput$VehsReg2024Q2 / LSOAoutput$TotHhold
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("../data/raw_data/df_VEH0145_col1345.csv")
names(EVReg)[1] <- "LSOA11CD"
EVReg$Fuel <- as.factor(EVReg$Fuel)
EVReg$Keepership <- as.factor(EVReg$Keepership)
#include only fully electric but company or private ownership
EVReg <- EVReg[which(EVReg$Fuel == "Battery electric"),]
EVReg <- EVReg[which(EVReg$Keepership == "Total"),]
EVReg <- EVReg[,c(1,4)]
EVReg$`2024 Q2` <- as.numeric(EVReg$`2024 Q2`)
names(EVReg)[2] <- "EV2024Q2"
EVReg$EV2024Q2 <- if_else(is.na(EVReg$EV2024Q2),0,EVReg$EV2024Q2)
LSOAoutput <- left_join(LSOAoutput,EVReg)
#round 17 outliers as did with total vehs - double max hholds per LSOA is 3954, so rounded to 4k
LSOAoutput$EV2024Q2 <- if_else(LSOAoutput$EV2024Q2 > 4000,
4000, LSOAoutput$EV2024Q2)
LSOAoutput$EVRate <- (LSOAoutput$EV2024Q2/LSOAoutput$VehsReg2024Q2)
#LSOA reduction in car ownership rates
LSOAoutput$CCCarOwn <- (LSOAoutput$VehsReg2024Q2 - 9)/LSOAoutput$TotHhold
LSOAoutput$CCredCarOwn <- (LSOAoutput$CCCarOwn - LSOAoutput$CarOwnRates)
#LSOA changes in EV uptake
LSOAoutput$LSOAEVincCC <- (LSOAoutput$EV2024Q2 + 9)
LSOAoutput$LSOAEVRateincCC <- (LSOAoutput$EVincCC/(LSOAoutput$VehsReg2024Q2-8))
LSOAoutput$LSOAChangeEVuptake <- (LSOAoutput$EVRateincCC - LSOAoutput$EVRate)*100
#LSOA changes in EV uptake
LSOAoutput$EVincCC <- (LSOAoutput$EV2024Q2 + 9)
LSOAoutput$EVRateincCC <- (LSOAoutput$EVincCC/(LSOAoutput$VehsReg2024Q2-8))
LSOAoutput$ChangeEVuptake <- (LSOAoutput$EVRateincCC - LSOAoutput$EVRate)*100
#aggregate populations, total households, car ownership and EV uptake by MSOA into new df
TotHholdMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
sum(TotHhold, na.rm = T))
names(TotHholdMSOA)[2] <- "TotHhold"
VehsRegMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
sum(VehsReg2024Q2, na.rm = T))
names(VehsRegMSOA)[2]<- "VehsReg"
MSOAoutput <- left_join(TotHholdMSOA, VehsRegMSOA)
MSOAoutput$CarOwnRates <- MSOAoutput$VehsReg / MSOAoutput$TotHhold
EVRegMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
sum(EV2024Q2, na.rm = T))
names(EVRegMSOA)[2]<-"EVReg"
MSOAoutput <- left_join(MSOAoutput, EVRegMSOA)
MSOAoutput$EVRate <- (MSOAoutput$EVReg/MSOAoutput$VehsReg)
#MSOA reduction in car ownership
MSOAoutput$CarRedincCC <- (MSOAoutput$VehsReg - 9)
MSOAoutput$CCCarOwn <- MSOAoutput$CarRedincCC/MSOAoutput$TotHhold
MSOAoutput$CCredCarOwn <- (MSOAoutput$CCCarOwn - MSOAoutput$CarOwnRates)
#MSOA changes in EV uptake
MSOAoutput$EVincCC <- (MSOAoutput$EVReg + 9)
MSOAoutput$EVRateincCC <- (MSOAoutput$EVincCC/(MSOAoutput$VehsReg - 8))
MSOAoutput$ChangeEVuptake <- (MSOAoutput$EVRateincCC - MSOAoutput$EVRate)*100
write.csv(MSOAoutput, "../data/processed_data/df_msoa.csv")
#aggregate total households, car ownership and EV uptake by LAD into new df
TotHholdLAD <- summarise(group_by(LSOAoutput, LAD22CD),
sum(TotHhold, na.rm = T))
names(TotHholdLAD) [2] <- "TotHhold"
VehsRegLAD <- summarise(group_by(LSOAoutput, LAD22CD),
sum(VehsReg2024Q2, na.rm = T))
names(VehsRegLAD)[2]<- "VehsReg"
LADoutput <- left_join(TotHholdLAD, VehsRegLAD)
LADoutput$CarOwnRates <- LADoutput$VehsReg / LADoutput$TotHhold
EVRegLAD <- summarise(group_by(LSOAoutput, LAD22CD),
sum(EV2024Q2, na.rm = T))
names(EVRegLAD)[2]<-"EVReg"
LADoutput <- left_join(LADoutput, EVRegLAD)
LADoutput$EVRate <- (LADoutput$EVReg/LADoutput$VehsReg)
#LAD reduction in car ownership
LADoutput$CarRedincCC <- (LADoutput$VehsReg - 9)
LADoutput$CCCarOwn <- LADoutput$CarRedincCC/LADoutput$TotHhold
LADoutput$CCredCarOwn <- (LADoutput$CCCarOwn - LADoutput$CarOwnRates)
#MSOA changes in EV uptake
LADoutput$EVincCC <- (LADoutput$EVReg + 9)
LADoutput$EVRateincCC <- (LADoutput$EVincCC/(LADoutput$VehsReg-8))
LADoutput$ChangeEVuptake <- (LADoutput$EVRateincCC - LADoutput$EVRate)*100
write.csv(LADoutput, "../data/processed_data/df_lad.csv")
#weighted LAD reduction in car ownership
W_CCCarOWN <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CarOwnRates), na.rm = T)
summary(W_CCCarOWN)
#weighted LAD reduction in car ownership
W_CCCarOWN <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CarOwnRates))
#weighted LAD reduction in car ownership
W_CCCredCarOwnLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CarRedincCC, TotHhold))
rlang::last_trace()
#weighted LAD reduction in car ownership
W_CCCredCarOwnLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CCredCarOwn, TotHhold))
summary(W_CCCredCarOwnLAD)
head(LADoutput$CCredCarOwn)
#weighted LAD reduction in car ownership
W_CCCredCarOwnLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CCredCarOwn))
summary(W_CCCredCarOwnLAD)
#weighted LAD reduction in car ownership
W_CCCredCarOwnLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CCredCarOwn, TotHhold))
names(W_CCCredCarOwnLAD)[2]<- "CCredCarOwn"
#LADoutput$ChangeEVuptake <- (LADoutput$EVRateincCC - LADoutput$EVRate)*100
W_CCEVuptakeLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(ChangeEVuptake, TotHhold))
names(W_CCEVuptakeLAD)[2]<- "ChangeEVuptake"
LADoutput <- left_join(LADoutput, W_CCEVuptakeLAD)
summary(LADoutput)
summary(LSOAoutput)
#aggregate populations, total households, car ownership and EV uptake by MSOA into new df
TotHholdMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
sum(TotHhold, na.rm = T))
names(TotHholdMSOA)[2] <- "TotHhold"
VehsRegMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
sum(VehsReg2024Q2, na.rm = T))
names(VehsRegMSOA)[2]<- "VehsReg"
MSOAoutput <- left_join(TotHholdMSOA, VehsRegMSOA)
MSOAoutput$CarOwnRates <- MSOAoutput$VehsReg / MSOAoutput$TotHhold
EVRegMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
sum(EV2024Q2, na.rm = T))
names(EVRegMSOA)[2]<-"EVReg"
MSOAoutput <- left_join(MSOAoutput, EVRegMSOA)
MSOAoutput$EVRate <- (MSOAoutput$EVReg/MSOAoutput$VehsReg)
#MSOA reduction in car ownership unweighted by LSOA household numbers
MSOAoutput$CarRedincCC <- (MSOAoutput$VehsReg - 9)
MSOAoutput$CCCarOwn <- MSOAoutput$CarRedincCC/MSOAoutput$TotHhold
#MSOAoutput$CCredCarOwn <- (MSOAoutput$CCCarOwn - MSOAoutput$CarOwnRates)
#MSOA reduction in car ownership weighted by LSOA household numbers
W_CCredCarOwnMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
weighted.mean(CCredCarOwn, TotHhold))
names(W_CCredCarOwnMSOA)[2]<- "CCredCarOwn"
MSOAoutput <- left_join(MSOAoutput, W_CCredCarOwnMSOA)
#MSOA changes in EV uptake unweighted by LSOA household numbers
MSOAoutput$EVincCC <- (MSOAoutput$EVReg + 9)
MSOAoutput$EVRateincCC <- (MSOAoutput$EVincCC/(MSOAoutput$VehsReg - 8))
#MSOAoutput$ChangeEVuptake <- (MSOAoutput$EVRateincCC - MSOAoutput$EVRate)*100
#MSOA changes in EV uptake weighted by LSOA household numbers
W_CCEVuptakeMSOA <- summarise(group_by(LSOAoutput, MSOA21CD),
weighted.mean(ChangeEVuptake, TotHhold))
names(W_CCEVuptakeMSOA)[2]<- "ChangeEVuptake"
MSOAoutput <- left_join(MSOAoutput, W_CCEVuptakeMSOA)
write.csv(MSOAoutput, "../data/processed_data/df_msoa.csv")
#aggregate total households, car ownership and EV uptake by LAD into new df
TotHholdLAD <- summarise(group_by(LSOAoutput, LAD22CD),
sum(TotHhold, na.rm = T))
names(TotHholdLAD) [2] <- "TotHhold"
VehsRegLAD <- summarise(group_by(LSOAoutput, LAD22CD),
sum(VehsReg2024Q2, na.rm = T))
names(VehsRegLAD)[2]<- "VehsReg"
LADoutput <- left_join(TotHholdLAD, VehsRegLAD)
LADoutput$CarOwnRates <- LADoutput$VehsReg / LADoutput$TotHhold
EVRegLAD <- summarise(group_by(LSOAoutput, LAD22CD),
sum(EV2024Q2, na.rm = T))
names(EVRegLAD)[2]<-"EVReg"
LADoutput <- left_join(LADoutput, EVRegLAD)
LADoutput$EVRate <- (LADoutput$EVReg/LADoutput$VehsReg)
#LAD reduction in car ownership unweighted by LSOA household numbers
LADoutput$CarRedincCC <- (LADoutput$VehsReg - 9)
LADoutput$CCCarOwn <- LADoutput$CarRedincCC/LADoutput$TotHhold
#LADoutput$CCredCarOwn <- (LADoutput$CCCarOwn - LADoutput$CarOwnRates)
#LAD reduction in car ownership weighted by LSOA household numbers
W_CCredCarOwnLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(CCredCarOwn, TotHhold))
names(W_CCredCarOwnLAD)[2]<- "CCredCarOwn"
LADoutput <- left_join(LADoutput, W_CCredCarOwnLAD)
#LAD changes in EV uptake unweighted by LSOA household numbers
LADoutput$EVincCC <- (LADoutput$EVReg + 9)
LADoutput$EVRateincCC <- (LADoutput$EVincCC/(LADoutput$VehsReg-8))
#LADoutput$ChangeEVuptake <- (LADoutput$EVRateincCC - LADoutput$EVRate)*100
#LAD changes in EV uptake unweighted by LSOA household numbers
W_CCEVuptakeLAD <- summarise(group_by(LSOAoutput, LAD22CD),
weighted.mean(ChangeEVuptake, TotHhold))
names(W_CCEVuptakeLAD)[2]<- "ChangeEVuptake"
LADoutput <- left_join(LADoutput, W_CCEVuptakeLAD)
write.csv(LADoutput, "../data/processed_data/df_lad.csv")
