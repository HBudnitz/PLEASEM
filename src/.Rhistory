"E07000026"|"E07000028"|"E07000029")
,2:6]))
Cumberland <- c("E06000063",
colSums(VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000026")|
which(VehFleet$`Local Authority Code` ==
"E07000028")|
which(VehFleet$`Local Authority Code` ==
"E07000029")
,2:6]))
summary(Cumberland)
Cumberland
Cumberland <- c("E06000063", apply(VehFleet[which(VehFleet$`Local Authority Code` ==
c("E07000026","E07000028","E07000029"),2:6]), 1, sum)
(VehFleet["E06000063","Diesel2024Q2"]+
VehFleet["E07000028","Diesel2024Q2"]+
TrafficFleet["E07000029","Diesel2024Q2"]),
(VehFleet["E06000063","Hybrid2024Q2"]+
VehFleet["E07000028","Hybrid2024Q2"]+
TrafficFleet["E07000029","Hybrid2024Q2"]),
(VehFleet["E06000063","BEV2024Q2"]+
VehFleet["E07000028","BEV2024Q2"]+
TrafficFleet["E07000029","BEV2024Q2"]),
(VehFleet["E06000063","PHEV2024Q2"]+
VehFleet["E07000028","PHEV2024Q2"]+
TrafficFleet["E07000029","PHEV2024Q2"]))
Cumberland <- c("E06000063", apply(VehFleet[which(VehFleet$`Local Authority Code` ==
c("E07000026","E07000028","E07000029")),2:6], 1, sum)
(VehFleet["E06000063","Diesel2024Q2"]+
VehFleet["E07000028","Diesel2024Q2"]+
TrafficFleet["E07000029","Diesel2024Q2"]),
(VehFleet["E06000063","Hybrid2024Q2"]+
VehFleet["E07000028","Hybrid2024Q2"]+
TrafficFleet["E07000029","Hybrid2024Q2"]),
(VehFleet["E06000063","BEV2024Q2"]+
VehFleet["E07000028","BEV2024Q2"]+
TrafficFleet["E07000029","BEV2024Q2"]),
(VehFleet["E06000063","PHEV2024Q2"]+
VehFleet["E07000028","PHEV2024Q2"]+
TrafficFleet["E07000029","PHEV2024Q2"]))
c("E07000026","E07000028","E07000029")),],VehFleet[,2:6])
Cumberland <- c("E06000063", colSums(filter(VehFleet[which(VehFleet$`Local Authority Code` ==
c("E07000026","E07000028","E07000029")),]),VehFleet[,2:6])
(VehFleet["E06000063","Diesel2024Q2"]+
VehFleet["E07000028","Diesel2024Q2"]+
TrafficFleet["E07000029","Diesel2024Q2"]),
(VehFleet["E06000063","Hybrid2024Q2"]+
VehFleet["E07000028","Hybrid2024Q2"]+
TrafficFleet["E07000029","Hybrid2024Q2"]),
(VehFleet["E06000063","BEV2024Q2"]+
VehFleet["E07000028","BEV2024Q2"]+
TrafficFleet["E07000029","BEV2024Q2"]),
(VehFleet["E06000063","PHEV2024Q2"]+
VehFleet["E07000028","PHEV2024Q2"]+
TrafficFleet["E07000029","PHEV2024Q2"]))
Cumberland <- filter(VehFleet[which(VehFleet$`Local Authority Code` ==
c("E07000026","E07000028","E07000029")),])
Cumberland <- filter(VehFleet$`Local Authority Code` ==
c("E07000026","E07000028","E07000029"))
Cumberland <- c("E06000063", colSums(filter(VehFleet$`Local Authority Code` ==
"E07000026" & VehFleet$`Local Authority Code` ==
"E07000028" & VehFleet$`Local Authority Code` ==
"E07000029")),VehFleet[,2:6])
Cumberland <- (filter(VehFleet$`Local Authority Code` ==
"E07000026" & VehFleet$`Local Authority Code` ==
"E07000028" & VehFleet$`Local Authority Code` ==
"E07000029")
c("E06000063", colSums),VehFleet[,2:6])
Cumberland <- filter(VehFleet$`Local Authority Code` ==
"E07000026" & VehFleet$`Local Authority Code` ==
"E07000028" & VehFleet$`Local Authority Code` ==
"E07000029")
Cumberland <- VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000026" | VehFleet$`Local Authority Code` ==
"E07000028" | VehFleet$`Local Authority Code` ==
"E07000029"),]
Cumberland2 <- c("E06000063", colSums(VehFleet[,2:6]))
Cumberland#
Cumberland2
Cumberland2 <- c("E06000063", rowSums(VehFleet[,2:6]))
Cumberland2 <- c("E06000063", colSums(Cumberland[,2:6]))
Cumberland2
VehFleet <- rbind(VehFleet, Cumberland2)
VehFleet[which(VehFleet$`Local Authority Code`== "E06000063")]
VehFleet[which(VehFleet$`Local Authority Code`== "E06000063"),]
WestmorlandFurness <- VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000027" | VehFleet$`Local Authority Code` ==
"E07000030" | VehFleet$`Local Authority Code` ==
"E07000031"),]
WestmorlandFurness2 <- c("E06000064", colSums(WestmorlandFurness[,2:6]))
WestmorlandFurness
WestmorlandFurness[,2:6]<- as.numeric(WestmorlandFurness[,2:6])
str(WestmorlandFurness)
WestmorlandFurness <- WestmorlandFurness %>% mutate_at(c(2:6), as.numeric)
WestmorlandFurness2 <- c("E06000064", colSums(WestmorlandFurness[,2:6]))
VehFleet <- rbind(VehFleet, WestmorlandFurness2)
VehFleet$TotalCars <- rowSums(VehFleet[2:6], na.rm = T)
VehFleet$Petrol <- VehFleet$Petrol2024Q2/VehFleet$TotalCars
VehFleet$Diesel <- VehFleet$Diesel2024Q2/VehFleet$TotalCars
VehFleet$Hybrid <- VehFleet$Hybrid2024Q2/VehFleet$TotalCars
VehFleet$BEV <- VehFleet$BEV2024Q2/VehFleet$TotalCars
VehFleet$PHEV <- VehFleet$PHEV2024Q2/VehFleet$TotalCars
TrafficFleet <- left_join(VehFleet, Traffic) #421 upper and lower tier authorities
#divide Cumbria's traffic into Cumberland and Westmoreland and Furness
#again, in future updates, this might not be necessary
CumbriaHalfMileage <- (TrafficFleet[which(TrafficFleet$`Local Authority` == "Cumbria"),"cars_and_taxis"])/2
#divide Cumbria's traffic into Cumberland and Westmoreland and Furness
#again, in future updates, this might not be necessary
(TrafficFleet[which(TrafficFleet$`Local Authority` == "Cumbria"),"cars_and_taxis"])
TrafficFleet$cars_and_taxis <- if_else(TrafficFleet$`Local Authority Code`== "E06000063"
| TrafficFleet$`Local Authority Code`== "E06000064",
TrafficFleet$cars_and_taxis == CumbriaHalfMileage,
TrafficFleet$cars_and_taxis)
TrafficFleet[which(TrafficFleet$`Local Authority` ==
"Cumberland")
TrafficFleet[which(TrafficFleet$`Local Authority` ==
"Cumberland"),]
TrafficFleet[which(TrafficFleet$`Local Authority` ==
"Cumberland"),]
TrafficFleet <- left_join(VehFleet, Traffic) #423 upper and lower tier authorities
#Clean dataframe and prepare for joining to geojson
#4 upper tier LAs have different codes in VehFleet files that are in Mileage files
#Somerset and North Yorkshire (changed lower tier code to upper tier code)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000027",
"E06000066", TrafficFleet$`Local Authority Code`)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000023",
"E06000065", TrafficFleet$`Local Authority Code`)
TrafficFleet[which(TrafficFleet$`Local Authority` ==
"Cumberland"),]
TrafficFleet <- left_join(VehFleet, Traffic) #423 upper and lower tier authorities
#Clean dataframe and prepare for joining to geojson
#4 upper tier LAs have different codes in VehFleet files that are in Mileage files
#Somerset and North Yorkshire (changed lower tier code to upper tier code)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000027",
"E06000066", TrafficFleet$`Local Authority Code`)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000023",
"E06000065", TrafficFleet$`Local Authority Code`)
#Three authorities have different names on the geojson
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Herefordshire",
"Herefordshire, County of", TrafficFleet$`Local Authority`)
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Bristol",
"Bristol, City of", TrafficFleet$`Local Authority`)
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Kingston upon Hull",
"Kingston upon Hull, City of", TrafficFleet$`Local Authority`)
summary(TrafficFleet)
head(TrafficFleet)
#remove 215 NAs
TrafficFleet <- TrafficFleet[!is.na(TrafficFleet$cars_and_taxis),]
TrafficFleet$PetrolMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Petrol
TrafficFleet$DieselMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Diesel
TrafficFleet$HybridMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Hybrid
TrafficFleet$BEVMile <- TrafficFleet$cars_and_taxis*TrafficFleet$BEV
TrafficFleet$PHEVMile <- TrafficFleet$cars_and_taxis*TrafficFleet$PHEV
TrafficFleet$PetrolCO2e <- TrafficFleet$PetrolMile*0.26473
TrafficFleet$DieselCO2e <- TrafficFleet$DieselMile*0.27334
library(dplyr)
#data on mileage on upper tier authority on all roads within that authority
#https://roadtraffic.dft.gov.uk/downloads (Local authority traffic)
Traffic <- read.csv("../data/raw_data/local_authority_traffic.csv")
Traffic <- Traffic[which(Traffic$year == 2023),c(2:3,5:8)]
names(Traffic)[1:2]<-c("Local Authority","Local Authority Code")
#data on vehicle fleet makeup by upper and lower tier local authority
#Table veh0105: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-tables
#extract data for all (private and company) cars (body type) by fuel type
VehFleet <- read.csv("../data/raw_data/VehReg.csv")
VehFleet <- VehFleet[,2:7]
VehFleet$BodyType <- as.factor(VehFleet$BodyType)
VehFleet$Fuel <- as.factor(VehFleet$Fuel)
VehFleet$Keepership <- as.factor(VehFleet$Keepership)
VehFleet$X2024.Q2 <- (as.numeric(VehFleet$X2024.Q2))*1000
VehFleet <- VehFleet[which(VehFleet$BodyType == "Cars"),]
VehFleet <- VehFleet[which(VehFleet$Keepership == "Total"),]
VehFleet <- VehFleet[which(VehFleet$Local.Authority.Code != "[z]"),]
Diesel <- VehFleet[which(VehFleet$Fuel == "Diesel"),c(4,6)]
names(Diesel)[2] <- "Diesel2024Q2"
Hybrid <- VehFleet[which(VehFleet$Fuel == "Hybrid electric (petrol)"),c(4,6)]
names(Hybrid)[2] <- "Hybrid2024Q2"
Petrol <- VehFleet[which(VehFleet$Fuel == "Petrol"),c(4,6)]
names(Petrol)[2] <- "Petrol2024Q2"
VehFleet <- left_join(Petrol, Diesel)
VehFleet <- left_join(VehFleet, Hybrid)
#Data on full EVs and plug in hybrids
#Table veh0142: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-tables
#extract data for all (private and company) cars (body type) by fuel type
Electric <- read.csv("../data/raw_data/PiEVReg.csv")
Electric <- Electric[,2:7]
Electric$BodyType <- as.factor(Electric$BodyType)
Electric$Fuel <- as.factor(Electric$Fuel)
Electric$Keepership <- as.factor(Electric$Keepership)
Electric$X2024.Q2 <- sub(",", "",Electric$X2024.Q2)
Electric$X2024.Q2 <- as.numeric(Electric$X2024.Q2)
Electric <- Electric[which(Electric$BodyType == "Cars"),]
Electric <- Electric[which(Electric$Keepership == "Total"),]
Electric <- Electric[which(Electric$Local.Authority.Code != "[z]"),]
BEV <- Electric[which(Electric$Fuel == "Battery electric"),c(4,6)]
names(BEV)[2] <- "BEV2024Q2"
BEV$BEV2024Q2 <- if_else(is.na(BEV$BEV2024Q2), 0,BEV$BEV2024Q2)
VehFleet <- left_join(VehFleet, BEV)
PHEV <- Electric[which(Electric$Fuel == "Plug-in hybrid electric (petrol)"),c(4,6)]
names(PHEV)[2] <- "PHEVpet"
PHEV$PHEVpet <- if_else(is.na(PHEV$PHEVpet), 0,PHEV$PHEVpet)
PHEV2 <- Electric[which(Electric$Fuel == "Plug-in hybrid electric (diesel)"),c(4,6)]
names(PHEV2)[2] <- "PHEVd"
PHEV2$PHEVd <- if_else(is.na(PHEV2$PHEVd), 0,PHEV2$PHEVd)
PHEV3 <- Electric[which(Electric$Fuel == "Range extended electric"),c(4,6)]
PHEV3$X2024.Q2 <- if_else(is.na(PHEV3$X2024.Q2), 0,PHEV3$X2024.Q2)
PHEV <- left_join(PHEV, PHEV2)
PHEV <- left_join(PHEV, PHEV3)
PHEV$PHEV2024Q2 <- rowSums(PHEV[2:4])
PHEV <- PHEV[,c(1,5)]
VehFleet <- left_join(VehFleet, PHEV)
names(VehFleet)[1]<-"Local Authority Code"
#Cumbria split into Cumberland (Allderdale, Copeland, Carlisle) and
#Westmorland and Furness (South Lakeland, Eden, Barrow in Furness)
#create new row for each, sum districts fleet make-up
#code may no longer be needed if data updates have also updated authority codes
Cumberland <- VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000026" | VehFleet$`Local Authority Code` ==
"E07000028" | VehFleet$`Local Authority Code` ==
"E07000029"),]
Cumberland2 <- c("E06000063", colSums(Cumberland[,2:6]))
VehFleet <- rbind(VehFleet, Cumberland2)
WestmorlandFurness <- VehFleet[which(VehFleet$`Local Authority Code` ==
"E07000027" | VehFleet$`Local Authority Code` ==
"E07000030" | VehFleet$`Local Authority Code` ==
"E07000031"),]
WestmorlandFurness <- WestmorlandFurness %>% mutate_at(c(2:6), as.numeric)
WestmorlandFurness2 <- c("E06000064", colSums(WestmorlandFurness[,2:6]))
VehFleet <- rbind(VehFleet, WestmorlandFurness2)
VehFleet <- VehFleet %>% mutate_at(c(2:6), as.numeric)
#Calculate total cars and percentages to determine 'average car' per upper tier LA
VehFleet$TotalCars <- rowSums(VehFleet[2:6], na.rm = T)
VehFleet$Petrol <- VehFleet$Petrol2024Q2/VehFleet$TotalCars
VehFleet$Diesel <- VehFleet$Diesel2024Q2/VehFleet$TotalCars
VehFleet$Hybrid <- VehFleet$Hybrid2024Q2/VehFleet$TotalCars
VehFleet$BEV <- VehFleet$BEV2024Q2/VehFleet$TotalCars
VehFleet$PHEV <- VehFleet$PHEV2024Q2/VehFleet$TotalCars
TrafficFleet <- left_join(VehFleet, Traffic) #423 upper and lower tier authorities
#Clean dataframe and prepare for joining to geojson
#4 upper tier LAs have different codes in VehFleet files that are in Mileage files
#Somerset and North Yorkshire (changed lower tier code to upper tier code)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000027",
"E06000066", TrafficFleet$`Local Authority Code`)
TrafficFleet$`Local Authority Code` <- if_else(TrafficFleet$`Local Authority Code` == "E10000023",
"E06000065", TrafficFleet$`Local Authority Code`)
#Three authorities have different names on the geojson
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Herefordshire",
"Herefordshire, County of", TrafficFleet$`Local Authority`)
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Bristol",
"Bristol, City of", TrafficFleet$`Local Authority`)
TrafficFleet$`Local Authority` <- if_else(TrafficFleet$`Local Authority` == "Kingston upon Hull",
"Kingston upon Hull, City of", TrafficFleet$`Local Authority`)
#remove 215 NAs - 208 upper tier LAs
TrafficFleet <- TrafficFleet[!is.na(TrafficFleet$cars_and_taxis),]
#calculate mileage and emissions by car type per upper tier LA
TrafficFleet$PetrolMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Petrol
TrafficFleet$DieselMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Diesel
TrafficFleet$HybridMile <- TrafficFleet$cars_and_taxis*TrafficFleet$Hybrid
TrafficFleet$BEVMile <- TrafficFleet$cars_and_taxis*TrafficFleet$BEV
TrafficFleet$PHEVMile <- TrafficFleet$cars_and_taxis*TrafficFleet$PHEV
TrafficFleet$PetrolCO2e <- TrafficFleet$PetrolMile*0.26473
TrafficFleet$DieselCO2e <- TrafficFleet$DieselMile*0.27334
TrafficFleet$HybridCO2e <- TrafficFleet$HybridMile*0.20288
TrafficFleet$BEVCO2e <- TrafficFleet$BEVMile*0.07015+(TrafficFleet$BEVMile*0.00620)
TrafficFleet$PHEVCO2e <- TrafficFleet$PHEVMile*(0.14989+0.02208+0.00195)
#sum baseline CO2e and baseline CO2e and mileage for per vehicle in LA fleet
TrafficFleet$BaseCO2e <- rowSums(TrafficFleet[,23:27], na.rm = TRUE)
TrafficFleet$pCarBaseCO2e <- TrafficFleet$BaseCO2e/TrafficFleet$TotalCars
TrafficFleet$pCarAnnMile <- TrafficFleet$cars_and_taxis/TrafficFleet$TotalCars
#use mileage in fleet to create conversion factors for CO2 emissions reductions per CC car
TrafficFleet$pBEVAnnCO2e <- TrafficFleet$pCarAnnMile*0.07015+(TrafficFleet$pCarAnnMile*0.00620)
TrafficFleet$pHyVAnnCO2e <- TrafficFleet$pCarAnnMile*0.20288
TrafficFleet$reduceCO2pBEVcc <- TrafficFleet$pCarBaseCO2e - TrafficFleet$pBEVAnnCO2e
TrafficFleet$reduceCO2pHyVc <- TrafficFleet$pCarBaseCO2e - TrafficFleet$pHyVAnnCO2e
#output to use in mapping
write.csv(TrafficFleet, "../data/processed_data/LAoutputFleet.csv")
library(dplyr)
library(data.table)
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- fread("../data/raw_data/LookupLtoMSOA21.csv")
Lookup21 <- LookupPC[,c(8:9)]
names(Lookup21)[1] <- "LSOA21CD"
names(Lookup21)[2] <- "MSOA21CD"
Lookup21 <- distinct(Lookup21) #43501obs
Lookup2011 <- read.csv("../data/raw_data/LSOA_(2011)_to_LSOA_(2021)_to_Local_Authority_District_(2022)_Lookup_for_England_and_Wales.csv")
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- fread("../data/raw_data/LookupLtoMSOA21.csv")
Lookup21 <- Lookup21[,c(8:9)]
names(Lookup21)[1] <- "LSOA21CD"
names(Lookup21)[2] <- "MSOA21CD"
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- fread("../data/raw_data/LookupLtoMSOA21.csv")
summary(Lookup21)
#upload lookup files to include LSOA and MSOA 2021 codes then LSOA 2011 codes for fleet data
Lookup21 <- read.csv("../data/raw_data/LookupLtoMSOA21.csv")
summary(Lookup21)
Lookup2011 <- read.csv("../data/raw_data/LSOA_(2011)_to_LSOA_(2021)_to_Local_Authority_District_(2022)_Lookup_for_England_and_Wales.csv")
Lookup2011 <- Lookup2011[,c(1,3,5:6)]
names (Lookup2011)[1] <- "LSOA11CD"
Lookup <- left_join(Lookup21, Lookup2011) #43621obs
#Total Hholds and type by LSOA
HHoldVars <- read.csv("../data/raw_data/HHoldAccommodationType.csv")
HHoldVars$X2021.super.output.area...lower.layer <-
substr(HHoldVars$X2021.super.output.area...lower.layer,1,9)
names(HHoldVars)[1] <- "LSOA21CD"
HHoldVars <- HHoldVars[,1:2]
HHoldVars$Total.hholds <- as.numeric(HHoldVars$Total.hholds)
MSOAoutput <- left_join(Lookup, HHoldVars)
#Add Car registration rates by LSOA
AllVehReg <- fread("..../data/raw_data/df_VEH0125_col13456.csv")
#Add Car registration rates by LSOA
AllVehReg <- fread("..../data/raw_data/df_VEH0125_col13456.csv")
#Add Car registration rates by LSOA
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "LSOAVehsReg2024Q2"
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
MSOAoutput <- MSOAoutput[!is.na(MSOAoutput$LSOAVehsReg2024Q2),]
str(AllVehReg)
AllVehReg$LSOA11CD <- as.character(AllVehReg$LSOA11CD)
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
MSOAoutput <- left_join(Lookup, HHoldVars)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
summary(AllVehReg)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
AllVehReg$LSOA11CD <- as.character(AllVehReg$LSOA11CD)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "LSOAVehsReg2024Q2"
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
str(AllVehReg)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
str(AllVehReg)
rm(AllVehReg)
MSOAoutput <- MSOAoutput[!is.na(MSOAoutput$LSOAVehsReg2024Q2),]
#round 53 LSOA outliers to account for where there are car rental businesses, fleets registered, etc
#double max hholds per LSOA is 3954, so maximum capped at 4k registered cars per LSOA
MSOAoutput$LSOAVehsReg2024Q2 <- if_else(MSOAoutput$LSOAVehsReg2024Q2 > 4000,
4000, MSOAoutput$LSOAVehsReg2024Q2)
#Rates of cars registered by total households
MSOAoutput$CarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$Total.hholds
#Rates of cars registered by total households
MSOAoutput$LSOACarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$Total.hholds
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("..../data/raw_data/df_VEH0145_col1345.csv")
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("../data/raw_data/df_VEH0145_col1345.csv")
names(EVReg)[1] <- "LSOA11CD"
EVReg$Fuel <- as.factor(EVReg$Fuel)
EVReg$Keepership <- as.factor(EVReg$Keepership)
#include only fully electric but company or private ownership
EVReg <- EVReg[which(EVReg$Fuel == "Battery electric"),]
EVReg <- EVReg[which(EVReg$Keepership == "Total"),]
EVReg <- EVReg[,c(1,4)]
EVReg$`2024 Q2` <- as.numeric(EVReg$`2024 Q2`)
names(EVReg)[2] <- "LSOAEV2024Q2"
EVReg$LSOAEV2024Q2 <- if_else(is.na(EVReg$LSOAEV2024Q2),0,EVReg$LSOAEV2024Q2)
MSOAoutput <- left_join(MSOAoutput,EVReg)
#round 17 outliers as did with total vehs - double max hholds per LSOA is 3954, so rounded to 4k
MSOAoutput$LSOAEV2024Q2 <- if_else(MSOAoutput$LSOAEV2024Q2 > 4000,
4000, MSOAoutput$LSOAEV2024Q2)
MSOAoutput$LSOAEVRate <- (MSOAoutput$LSOAEV2024Q2/MSOAoutput$LSOAVehsReg2024Q2)
#LSOA reduction in car ownership rates
MSOAoutput$LSOACCCarOwn <- (MSOAoutput$LSOAVehsReg2024Q2 - 9)/MSOAoutput$Total.hholds
MSOAoutput$LSOACCredCarOwn <- (MSOAoutput$LSOACCCarOwn - MSOAoutput$LSOACarOwnRates)
#LSOA changes in EV uptake
MSOAoutput$LSOAEVincCC <- (MSOAoutput$LSOAEV2024Q2 + 9)
MSOAoutput$LSOAEVRateincCC <- (MSOAoutput$LSOAEVincCC/(MSOAoutput$LSOAVehsReg2024Q2-8))
MSOAoutput$LSOAChangeEVuptake <- (MSOAoutput$LSOAEVRateincCC - MSOAoutput$LSOAEVRate)*100
#aggregate populations, total households, car ownership and EV uptake by MSOA
TotHholdMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(Total.hholds, na.rm = T))
names(TotHholdMSOA)[2] <- "TotHholdMSOA"
MSOAoutput <- left_join(MSOAoutput, TotHholdMSOA)
#Total Hholds by LSOA
#data from census: https://www.nomisweb.co.uk/query/select/getdatasetbytheme.asp
#select census 2021, Table 041 number of households, geography: all 2021 super output areas - lower layer
HHolds <- read.csv("../data/raw_data/HHoldNumbers.csv")
summary(HHolds)
HHoldVars$X2021.super.output.area...lower.layer <-
substr(HHoldVars$X2021.super.output.area...lower.layer,1,9)
HHolds$X2021.super.output.area...lower.layer <-
substr(HHolds$X2021.super.output.area...lower.layer,1,9)
names(HHolds)[1] <- "LSOA21CD"
names(HHolds) <- c("LSOA21CD","LSOAtotHholds")
HHolds$LSOAtotHholds <- as.numeric(HHolds$LSOAtotHholds)
MSOAoutput <- left_join(Lookup, HHolds)
#Add Car registration rates by LSOA
#Table veh0125: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, 5, and 6 extracted to reduce size to save to Github
AllVehReg <- fread("../data/raw_data/df_VEH0125_col13456.csv")
AllVehReg$LicenceStatus <- as.factor(AllVehReg$LicenceStatus)
#remove 'SORN' as are registered as such if broken, untaxed, etc - not allowed on road
AllVehReg <- AllVehReg[which(AllVehReg$LicenceStatus == "Licensed"),]
names(AllVehReg)[1] <- "LSOA11CD"
AllVehReg$BodyType <- as.factor(AllVehReg$BodyType)
AllVehReg$Keepership <- as.factor(AllVehReg$Keepership)
#BodyType include Cars only, not Motorcycles or Other body types
#Keepership include private and company, as company cars a key form of car ownership, esp for EVs
AllVehReg <- AllVehReg[which(AllVehReg$BodyType == "Cars"),]
AllVehReg <- AllVehReg[which(AllVehReg$Keepership == "Total"),] #42620 obs - extra LSOAs because include Scotland / NI?
AllVehReg$`2024 Q2` <- as.numeric(AllVehReg$`2024 Q2`)
#Keep only latest quarter and LSOA11 code
AllVehReg <- AllVehReg[,c(1,5)]
names(AllVehReg)[2] <- "LSOAVehsReg2024Q2"
MSOAoutput <- left_join(MSOAoutput, AllVehReg)
MSOAoutput <- MSOAoutput[!is.na(MSOAoutput$LSOAVehsReg2024Q2),] #remove Scotland - 34753 obs
#round 53 LSOA outliers to account for where there are car rental businesses, fleets registered, etc
#double max hholds per LSOA is 3954, so maximum capped at 4k registered cars per LSOA
MSOAoutput$LSOAVehsReg2024Q2 <- if_else(MSOAoutput$LSOAVehsReg2024Q2 > 4000,
4000, MSOAoutput$LSOAVehsReg2024Q2)
#Rates of cars registered by total households
MSOAoutput$LSOACarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$Total.hholds
#EV registrations by LSOA - all plug-in vehicles, inc hybrids and Range extended
#Table veh0145: https://www.gov.uk/government/statistical-data-sets/vehicle-licensing-statistics-data-files
#Columns 1, 3, 4, and 5 extracted to reduce size to save to Github
EVReg <- fread("../data/raw_data/df_VEH0145_col1345.csv")
#Rates of cars registered by total households
MSOAoutput$LSOACarOwnRates <- MSOAoutput$LSOAVehsReg2024Q2 / MSOAoutput$LSOAtotHholds
names(EVReg)[1] <- "LSOA11CD"
EVReg$Fuel <- as.factor(EVReg$Fuel)
EVReg$Keepership <- as.factor(EVReg$Keepership)
#include only fully electric but company or private ownership
EVReg <- EVReg[which(EVReg$Fuel == "Battery electric"),]
EVReg <- EVReg[which(EVReg$Keepership == "Total"),]
EVReg <- EVReg[,c(1,4)]
EVReg$`2024 Q2` <- as.numeric(EVReg$`2024 Q2`)
names(EVReg)[2] <- "LSOAEV2024Q2"
EVReg$LSOAEV2024Q2 <- if_else(is.na(EVReg$LSOAEV2024Q2),0,EVReg$LSOAEV2024Q2)
MSOAoutput <- left_join(MSOAoutput,EVReg)
#round 17 outliers as did with total vehs - double max hholds per LSOA is 3954, so rounded to 4k
MSOAoutput$LSOAEV2024Q2 <- if_else(MSOAoutput$LSOAEV2024Q2 > 4000,
4000, MSOAoutput$LSOAEV2024Q2)
MSOAoutput$LSOAEVRate <- (MSOAoutput$LSOAEV2024Q2/MSOAoutput$LSOAVehsReg2024Q2)
#LSOA reduction in car ownership rates
MSOAoutput$LSOACCCarOwn <- (MSOAoutput$LSOAVehsReg2024Q2 - 9)/MSOAoutput$Total.hholds
MSOAoutput$LSOACCredCarOwn <- (MSOAoutput$LSOACCCarOwn - MSOAoutput$LSOACarOwnRates)
#LSOA changes in EV uptake
MSOAoutput$LSOAEVincCC <- (MSOAoutput$LSOAEV2024Q2 + 9)
#LSOA reduction in car ownership rates
MSOAoutput$LSOACCCarOwn <- (MSOAoutput$LSOAVehsReg2024Q2 - 9)/MSOAoutput$LSOAtotHholds
MSOAoutput$LSOACCredCarOwn <- (MSOAoutput$LSOACCCarOwn - MSOAoutput$LSOACarOwnRates)
#LSOA changes in EV uptake
MSOAoutput$LSOAEVincCC <- (MSOAoutput$LSOAEV2024Q2 + 9)
MSOAoutput$LSOAEVRateincCC <- (MSOAoutput$LSOAEVincCC/(MSOAoutput$LSOAVehsReg2024Q2-8))
MSOAoutput$LSOAChangeEVuptake <- (MSOAoutput$LSOAEVRateincCC - MSOAoutput$LSOAEVRate)*100
#aggregate populations, total households, car ownership and EV uptake by MSOA
TotHholdMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(Total.hholds, na.rm = T))
#aggregate populations, total households, car ownership and EV uptake by MSOA
TotHholdMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(LSOAtotHholds, na.rm = T))
names(TotHholdMSOA)[2] <- "TotHhold"
MSOAoutput <- left_join(MSOAoutput, TotHholdMSOA)
VehsRegMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(LSOAVehsReg2024Q2, na.rm = T))
names(VehsRegMSOA)[2]<- "VehsReg"
MSOAoutput <- left_join(MSOAoutput, VehsRegMSOA)
MSOAoutput$CarOwnRates <- MSOAoutput$VehsReg / MSOAoutput$TotHhold
EVRegMSOA <- summarise(group_by(MSOAoutput, MSOA21CD),
sum(LSOAEV2024Q2, na.rm = T))
names(EVRegMSOA)[2]<-"EVReg"
MSOAoutput <- left_join(MSOAoutput, EVRegMSOA)
MSOAoutput$EVRate <- (MSOAoutput$EVReg/MSOAoutput$VehsReg)
#MSOA reduction in car ownership
MSOAoutput$CarRedincCC <- (MSOAoutput$VehsReg - 9)
?weighted.mean
